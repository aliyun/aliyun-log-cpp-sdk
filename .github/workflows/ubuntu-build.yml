name: ubuntu
run-name: ${{ github.actor }} is building on ubuntu by GitHub Actions ðŸš€
on:   
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Run the build with tmate debugging enabled'
        required: false
        default: false
  push:

jobs:
  job:
    env:
      BUILD_TYPE: Release
      SYSTEM_LIB_DIR: /usr/lib/x86_64-linux-gnu
      TRIPLET: x64-ubuntu 

    name: x64
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Show workspace files
        run: find . | grep -v '\.git' | grep -v vcpkg | grep -v include
        shell: bash

      - name: Install deps
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libprotobuf-dev protobuf-compiler liblz4-dev libcurl4-openssl-dev
          version: 1.0
          execute_install_scripts: true

      - name: Cmake configure
        run: |
          cmake -B build -DBUILD_SHARE_LIBS=ON -DVERBOSE=ON -DBUILD_SAMPLE=ON \
              -DBUILD_TESTS=ON  \
              -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

      - name: Build
        run: |
          cmake --build build --clean-first --config ${{env.BUILD_TYPE}}
  
      - name: Install
        run: |
          cmake --install build --prefix ${{github.workspace}}

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}
      # - name: test build standalone sample
      #   run:
      #     | 
      #       cmake -B build -DCMAKE_BUILD_TYPE=Release
      #       cmake --build build --clean-first --config Release
      #       rm -rf build
      #   shell: bash
      #   working-directory: ${{github.workspace}}/aliyun-log-cpp-sdk/build  

      
      - name: Copy libs
        run: |
              mkdir -p ${{env.TRIPLET}}
                cp $SYSTEM_LIB_DIR/liblz4.* ./${{env.TRIPLET}}/
                cp $SYSTEM_LIB_DIR/libprotobuf.* ./${{env.TRIPLET}}/
                cp $SYSTEM_LIB_DIR/libcurl* ./${{env.TRIPLET}}/

        working-directory:  ${{github.workspace}}/lib

      - name: Show installed files
        run: |
            ls -lshtrR lib
            ls -lshtrR bin
            ls -lshtr include

      # - name: Set env
      #   run: echo "GITHUB_SHA_SHAORT=$(echo $GITHUB_SHA | cut -c 1-6)" >> $GITHUB_ENV

      # - name: Set env
      #   run: echo "TARGET_FILE=release/ubuntu-x64-${GITHUB_SHA_SHAORT}.tar.gz" >> $GITHUB_ENV  

      - name: Set target file name
        run: echo "TARGET_FILE=release/${{env.TRIPLET}}-latest.tar.gz" >> "$GITHUB_ENV"
      
      - name: Copy files for release
        run: |
            mkdir -p release 
            mkdir -p aliyun-log-cpp-sdk
            cp -rf bin lib include cmake example test *.cpp *.h \
              *.md Makefile *.proto ./aliyun-log-cpp-sdk/
        shell: bash

      - name: Compress
        uses: a7ul/tar-action@v1.1.0
        id: compress
        with:
          command: c
          cwd: ./
          files: |
            ./aliyun-log-cpp-sdk
          outPath: ${{env.TARGET_FILE}}

      - name: Show release file
        run: |
          ls -lshtr ${{env.TARGET_FILE}}

      - name: Save as aritifact
        uses: actions/upload-artifact@v2
        with:
          name: ${{env.TRIPLET}}-latest-artifact
          path: ${{env.TARGET_FILE}}
          retention-days: 7
