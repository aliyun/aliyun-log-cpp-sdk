name: Windows
run-name: ${{ github.actor }} is building by GitHub Actions ðŸš€
on: [workflow_dispatch, push]

jobs:
  job:
    env:
      VCPKG_DEFAULT_TRIPLET: ${{ matrix.triplet }}
      VCPKG_DIR: ${{github.workspace}}/vcpkg
      VCPKG_COMMIT: 0fa8459cf3a7caca7adc58f992bc32ff13630684
      BUILD_TYPE: Release
      # Generator: Ninja
    

    name: ${{ matrix.os }}-${{ github.workflow }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]
        # os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: windows-latest
            triplet: x64-windows
          # - os: ubuntu-latest
          #   triplet: x64-linux
          # - os: macos-latest
          #   triplet: x64-osx


    steps:
      - uses: actions/checkout@v3
      - uses: lukka/get-cmake@latest
      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v1.3.1

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@main
        id: runvcpkg
        with:
          vcpkgDirectory: ${{ env.VCPKG_DIR }}
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
          # vcpkgJsonGlob: 'vcpkg.json'
      
      - name: Install deps
        run: |
          vcpkg install --triplet ${{matrix.triplet}} protobuf lz4 curl
          vcpkg integrate install

      - name: List $RUNNER_WORKSPACE before build
        run: find . | grep -v '\.git' | grep -v vcpkg | grep -v include
        shell: bash

      # if path has \ in it, use powershell
      - name: cmake configure
        env:
          TOOL_CHAIN_FILE: ${{ env.VCPKG_DIR }}/scripts/buildsystems/vcpkg.cmake
        shell: pwsh
        run: |
          echo ${{env.TOOL_CHAIN_FILE}}
          cmake -DCMAKE_TOOLCHAIN_FILE=${{env.TOOL_CHAIN_FILE}} `
                -DVCPKG_TARGET_TRIPLET=${{matrix.triplet}} `
                -DVCPKG_MANIFEST_MODE=OFF `
                -B build -DPUBLISH=ON `
                -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} `
                -DBUILD_SAMPLE=ON -DBUILD_TESTS=ON `
                -DVERBOSE=ON -DBUILD_SHARE_LIBS=ON  
        

      - name: build
        run: |
          cmake --build build --clean-first --config ${{env.BUILD_TYPE}}

      - name: install
        env:
          INSTALL_PREFIX: ${{github.workspace}}/aliyun-log-cpp-sdk/build
        run: |
          cmake --install build --prefix ${{env.INSTALL_PREFIX}}
      
      - name: test build standalone sample
        run:
          | 
              cmake -B build -DCMAKE_BUILD_TYPE=Release
              cmake --build build --clean-first --config Release
              rm -rf build
        shell: bash
        working-directory: ${{github.workspace}}/aliyun-log-cpp-sdk/build


      - name: copy files
        run: cp -rf *.h *.cpp *.proto CMakeLists.txt Findlz4.cmake Makefile *.md aliyun-log-cpp-sdk/
        shell: bash

      - name: List release dir
        run: find .
        shell: bash
        working-directory: ${{github.workspace}}/aliyun-log-cpp-sdk

      - run: mkdir -p release 
        name: mkdir
        shell: pwsh

      # - name: Set env
      #   run: echo "GITHUB_SHA_SHAORT=$(echo $GITHUB_SHA | cut -c 1-6)" >> $GITHUB_ENV

      - name: Set env
        run: echo "TARGET_FILE=release/windows-x64-latest.tar.gz" >> $env:GITHUB_ENV
        shell: pwsh
      
      - name: Compress action step
        uses: a7ul/tar-action@v1.1.0
        id: compress
        with:
          command: c
          cwd: ./
          files: |
            ./aliyun-log-cpp-sdk
          outPath: ${{env.TARGET_FILE}}

      - name: cat tar file info
        run: |
          ls -l ${{env.TARGET_FILE}}
          
      - name: save as aritifact
        uses: actions/upload-artifact@v2
        with:
          name: windows-x64-latest-artifact
          path: ${{env.TARGET_FILE}}
          retention-days: 7
